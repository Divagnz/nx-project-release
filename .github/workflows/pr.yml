name: Pull Request

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npx nx lint @nx-project-release

      - name: Build
        run: npx nx build @nx-project-release

      - name: Test
        run: npx nx test @nx-project-release

      - name: Release Dry Run - Show Analysis
        id: release-preview
        run: |
          echo "## ðŸ” Release Preview - What Would Happen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This shows what the release process would do if this PR is merged:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Capture the show output
          OUTPUT=$(npx nx run @nx-project-release:version --show 2>&1 || true)

          # Check if there would be a version change
          if echo "$OUTPUT" | grep -q "New version:"; then
            CURRENT_VERSION=$(echo "$OUTPUT" | grep "Current version:" | awk '{print $3}')
            NEW_VERSION=$(echo "$OUTPUT" | grep "New version:" | awk '{print $3}')
            CHANGE_TYPE=$(echo "$OUTPUT" | grep "Detected:" | awk '{print $2}')

            echo "### âœ… Version Change Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Current Version**: \`$CURRENT_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **New Version**: \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Change Type**: \`$CHANGE_TYPE\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### ðŸ“ Release Actions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "When merged to main, the automated release will:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ”¢ Bump version from \`$CURRENT_VERSION\` â†’ \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“ Generate CHANGELOG.md from conventional commits" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ’¾ Create git commit: \`chore(release): @nx-project-release version $NEW_VERSION [skip ci]\`" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ·ï¸ Create git tag: \`v$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ“¤ Push commit and tag to main" >> $GITHUB_STEP_SUMMARY
            echo "6. ðŸŽ‰ Create GitHub Release for \`v$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "7. ðŸ“¦ Publish \`@divagnz/nx-project-release@$NEW_VERSION\` to npm" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            echo "### â„¹ï¸ No Version Change" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No release will be triggered - no conventional commits detected since last release." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          # Add full analysis details
          echo "### ðŸ“Š Detailed Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Dry Run - Version Check
        run: |
          echo "Running version dry-run to validate configuration..."
          npx nx run @nx-project-release:version --dryRun

      - name: Dry Run - Changelog Check
        run: |
          echo "Running changelog dry-run to validate configuration..."
          npx nx run @nx-project-release:changelog --dryRun

      - name: Dry Run - Publish Check
        run: |
          echo "Running publish dry-run to validate configuration..."
          npx nx run @nx-project-release:publish --dryRun

      - name: Comment on PR
        if: steps.release-preview.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newVersion = '${{ steps.release-preview.outputs.new_version }}';
            const body = `## ðŸš€ Release Preview

            This PR will trigger a **release** when merged to main.

            ### Version Change
            - **New Version**: \`${newVersion}\`
            - **Package**: \`@divagnz/nx-project-release@${newVersion}\`

            ### What will happen:
            1. âœ… Version bump
            2. âœ… Changelog generation
            3. âœ… Git tag creation
            4. âœ… GitHub Release
            5. âœ… npm publish

            See the [job summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed analysis.

            ---
            *ðŸ¤– This is an automated release preview*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
